<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job-Post-Enhanced</title>
  <!-- 引入 Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* 全局盒模型调整 */
    * {
      box-sizing: border-box;
    }
    /* 全局字体和背景色 */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 10px;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    /* 页面标题 */
    h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 20px;
      color: #444;
    }
    /* 筛选框样式 */
    #filterDiv {
      margin-bottom: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    #filterDiv select,
    #filterDiv input[type="text"] {
      padding: 8px 10px;
      font-size: 16px;
      margin: 0 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #filterDiv label {
      font-size: 16px;
      margin: 0 8px;
    }
    #filterDiv input[type="checkbox"] {
      margin-right: 5px;
    }
    /* 布局：左右面板 */
    #container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    #leftPanel {
      width: 35%;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      overflow-y: auto;
      height: 80vh;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    #rightPanel {
      flex: 1;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      overflow-y: auto;
      height: 80vh;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    /* 表格样式 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
      word-wrap: break-word;
      transition: background-color 0.25s ease, color 0.25s ease;
    }
    th {
      background-color: #f8f8f8;
      font-weight: 500;
    }
    tr:nth-child(even) {
      background-color: #fdfdfd;
    }
    tr:hover {
      background-color: #e3f2fd;
      cursor: pointer;
    }
    tr.selected {
      background-color: #bbdefb !important;
    }
    /* 可排序列指针效果 */
    th.sortable {
      cursor: pointer;
      position: relative;
    }
    th.sortable .sort-indicator {
      font-size: 0.8em;
      margin-left: 5px;
      color: #777;
    }
    /* 详细信息卡片样式 */
    #jobDetail {
      font-size: 1em;
      line-height: 1.8;
    }
    #jobDetail p {
      margin: 10px 0;
    }
    #jobDetail table {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    #jobDetail th,
    #jobDetail td {
      padding: 8px;
      border: 1px solid #eee;
    }
    #jobDetail th {
      background-color: #f0f0f0;
      width: 30%;
      font-weight: 500;
    }
    /* 禁止渲染图片、logo 元素以及特定 SVG 图标 */
    img,
    .logo,
    svg.jss131 {
      display: none !important;
    }
    /* 合并“职位摘要”单元格的样式 */
    .job-summary div {
      margin-bottom: 4px;
    }
    /* 固定左侧表格的表头 */
    #summaryTableContainer table thead th {
      position: sticky;
      top: 0;
      background-color: #f8f8f8;
      z-index: 2;
    }
    /* 小屏幕自适应 */
    @media (max-width: 600px) {
      body {
        margin: 10px;
      }
      h1 {
        font-size: 1.8em;
      }
      #container {
        flex-direction: column;
      }
      #leftPanel, #rightPanel {
        width: 100%;
        height: auto;
        border: none;
        padding: 10px;
        box-shadow: none;
      }
      #filterDiv {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>Job-Post-Enhanced</h1>
  <div id="filterDiv">
    <!-- 类型筛选 -->
    <label for="jobTypeSelect">选择类型:</label>
    <select id="jobTypeSelect">
      <option value="">全部</option>
      <option value="Graduate Position">Graduate Position</option>
      <option value="Part-time Position">Part-time Position</option>
      <option value="Temporary Position">Temporary Position</option>
      <option value="Student Assistants via Work-on-Campus by CPS">Student Assistants via Work-on-Campus by CPS</option>
      <option value="Internship Position - Half-或 One-year Internship">Internship Position - Half-或 One-year Internship</option>
      <option value="Internship Position - Summer Internship">Internship Position - Summer Internship</option>
      <option value="Internship Position - Winter Internship">Internship Position - Winter Internship</option>
      <option value="Internship Position - Government Internship">Internship Position - Government Internship</option>
      <option value="Internship Position - STEM Internship">Internship Position - STEM Internship</option>
    </select>
    <!-- 搜索功能 -->
    <label for="searchInput">搜索:</label>
    <input type="text" id="searchInput" placeholder="输入关键词">
    <label for="caseSensitive">
      <input type="checkbox" id="caseSensitive"> 区分大小写
    </label>
  </div>
  
  <div id="container">
    <div id="leftPanel">
      <div id="summaryTableContainer">加载中...</div>
    </div>
    <div id="rightPanel">
      <div id="jobDetail">
        <p>点击左侧项目查看详细信息</p>
      </div>
    </div>
  </div>
  
  <!-- 引入 SheetJS XLSX 库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      let allTableData = [];
      let filteredData = [];
      let currentSortColumn = null; // 当前排序字段
      let sortOrderAsc = true;      // true 为正序

      // 用于筛选“类型”的列索引
      let typeColumnIndex = -1;
      // 用于右侧显示“工作详情(HTML)”的列索引
      let detailColumnIndex = -1;
      
      // 定义各字段在 Excel 表头中的索引（合并后“职位摘要”内容需以下四项）
      let indexCompany = -1,
          indexPosition = -1,
          indexSalary = -1,
          indexType = -1,
          indexRecruitmentID = -1,
          indexPostDate = -1,
          indexDeadline = -1;
      
      // 读取 Excel 数据
      fetch("job_listings.xlsx")
        .then(response => response.arrayBuffer())
        .then(data => {
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          allTableData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          if (allTableData.length === 0) {
            document.getElementById("summaryTableContainer").innerHTML = "Excel 数据为空。";
            return;
          }
          
          const headerRow = allTableData[0];
          // 读取合并列所需字段的索引
          indexCompany = headerRow.indexOf("公司名");
          indexPosition = headerRow.indexOf("职位");
          indexSalary = headerRow.indexOf("薪资");
          indexType = headerRow.indexOf("类型");
          // 其他保持独立显示的列
          indexRecruitmentID = headerRow.indexOf("招聘编号");
          indexPostDate = headerRow.indexOf("发布时间");
          indexDeadline = headerRow.indexOf("截止日期");
          
          // “类型”筛选
          typeColumnIndex = headerRow.indexOf("类型");
          if (typeColumnIndex === -1) {
            console.warn("未找到‘类型’列，筛选功能将不可用。");
          }
          // “工作详情(HTML)”列
          detailColumnIndex = headerRow.indexOf("工作详情(HTML)");
          if (detailColumnIndex === -1) {
            console.warn("未找到‘工作详情(HTML)’列，右侧详细信息将不可用。");
          }
          
          // 初始显示全部数据
          filteredData = allTableData;
          renderSummaryTable(filteredData);
        })
        .catch(error => {
          console.error("读取 Excel 文件失败：", error);
          document.getElementById("summaryTableContainer").innerHTML = "无法加载 Excel 数据。";
        });
      
      // 筛选事件绑定
      document.getElementById("jobTypeSelect").addEventListener("change", filterData);
      document.getElementById("searchInput").addEventListener("input", filterData);
      document.getElementById("caseSensitive").addEventListener("change", filterData);
      
      // 综合筛选（类型和搜索）
      function filterData() {
        const selectedType = document.getElementById("jobTypeSelect").value;
        const searchQuery = document.getElementById("searchInput").value;
        const caseSensitive = document.getElementById("caseSensitive").checked;
        
        // 除表头外所有数据
        let data = allTableData.slice(1);
        
        if (selectedType !== "" && typeColumnIndex !== -1) {
          data = data.filter(row => row[typeColumnIndex] === selectedType);
        }
        
        if (searchQuery.trim() !== "") {
          data = data.filter(row => {
            return row.some(cell => {
              const cellText = cell !== undefined ? cell.toString() : "";
              if (!caseSensitive) {
                return cellText.toLowerCase().includes(searchQuery.toLowerCase());
              } else {
                return cellText.includes(searchQuery);
              }
            });
          });
        }
        
        filteredData = [allTableData[0]].concat(data);
        currentSortColumn = null;
        sortOrderAsc = true;
        renderSummaryTable(filteredData);
        document.getElementById("jobDetail").innerHTML = "<p>点击左侧项目查看详细信息</p>";
      }
      
      // 渲染左侧概要列表（四列显示）
      function renderSummaryTable(data) {
        const container = document.getElementById("summaryTableContainer");
        container.innerHTML = "";
        
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const trHead = document.createElement("tr");
        
        // 新的表头数组：首先是合并列"职位摘要"，后面依次"招聘编号"、"发布时间"、"截止日期"
        const headerNames = ["职位摘要", "招聘编号", "发布时间", "截止日期"];
        // 定义可排序的列
        const sortableColumns = ["招聘编号", "发布时间", "截止日期"];
        
        headerNames.forEach(name => {
          const th = document.createElement("th");
          th.textContent = name;
          if (sortableColumns.includes(name)) {
            th.classList.add("sortable");
            th.addEventListener("click", function() {
              sortSummaryByColumn(name);
            });
            const indicator = document.createElement("span");
            indicator.textContent = " ⇅";
            indicator.className = "sort-indicator";
            th.appendChild(indicator);
          }
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table.appendChild(thead);
        
        const tbody = document.createElement("tbody");
        
        // 遍历数据（跳过表头）
        data.slice(1).forEach(row => {
          const tr = document.createElement("tr");
          
          // 第一列：合并“公司名”、“职位”、“薪资”、“类型”
          const tdSummary = document.createElement("td");
          const company = (indexCompany !== -1 && row[indexCompany] !== undefined) ? row[indexCompany] : "";
          const position = (indexPosition !== -1 && row[indexPosition] !== undefined) ? row[indexPosition] : "";
          const salary = (indexSalary !== -1 && row[indexSalary] !== undefined) ? row[indexSalary] : "";
          const type = (indexType !== -1 && row[indexType] !== undefined) ? row[indexType] : "";
          tdSummary.innerHTML = `<div class="job-summary">
            <div><strong>公司名:</strong> ${company}</div>
            <div><strong>职位:</strong> ${position}</div>
            <div><strong>薪资:</strong> ${salary}</div>
            <div><strong>类型:</strong> ${type}</div>
          </div>`;
          tr.appendChild(tdSummary);
          
          // 第二列：招聘编号
          const tdRecruitment = document.createElement("td");
          tdRecruitment.textContent = (indexRecruitmentID !== -1 && row[indexRecruitmentID] !== undefined) ? row[indexRecruitmentID] : "";
          tr.appendChild(tdRecruitment);
          
          // 第三列：发布时间
          const tdPostDate = document.createElement("td");
          tdPostDate.textContent = (indexPostDate !== -1 && row[indexPostDate] !== undefined) ? row[indexPostDate] : "";
          tr.appendChild(tdPostDate);
          
          // 第四列：截止日期
          const tdDeadline = document.createElement("td");
          tdDeadline.textContent = (indexDeadline !== -1 && row[indexDeadline] !== undefined) ? row[indexDeadline] : "";
          tr.appendChild(tdDeadline);
          
          // 点击行显示右侧详细信息
          tr.addEventListener("click", function() {
            showJobDetails(row);
            Array.from(tbody.getElementsByTagName("tr")).forEach(r => r.classList.remove("selected"));
            tr.classList.add("selected");
          });
          tbody.appendChild(tr);
        });
        
        table.appendChild(tbody);
        container.appendChild(table);
      }
      
      // 排序功能（仅针对“招聘编号”、“发布时间”、“截止日期”这三列）
      function sortSummaryByColumn(columnName) {
        if (!filteredData || filteredData.length < 2) return;
        
        // 确定排序时所使用的原始 Excel 列索引
        let sortIndex = -1;
        if (columnName === "招聘编号") {
          sortIndex = indexRecruitmentID;
        } else if (columnName === "发布时间") {
          sortIndex = indexPostDate;
        } else if (columnName === "截止日期") {
          sortIndex = indexDeadline;
        }
        if (sortIndex === -1) return;
        
        if (currentSortColumn === columnName) {
          sortOrderAsc = !sortOrderAsc;
        } else {
          currentSortColumn = columnName;
          sortOrderAsc = true;
        }
        
        const headerRow = filteredData[0];
        const sortedRows = filteredData.slice(1).sort((a, b) => {
          let valA = a[sortIndex] || "";
          let valB = b[sortIndex] || "";
          
          // 如果是日期列，则尝试解析日期
          if (["发布时间", "截止日期"].includes(columnName)) {
            const dateA = Date.parse(valA);
            const dateB = Date.parse(valB);
            if (!isNaN(dateA) && !isNaN(dateB)) {
              return sortOrderAsc ? dateA - dateB : dateB - dateA;
            }
          }
          // 数字比较
          const numA = parseFloat(valA);
          const numB = parseFloat(valB);
          if (!isNaN(numA) && !isNaN(numB)) {
            return sortOrderAsc ? numA - numB : numB - numA;
          }
          // 默认字符串比较
          if (valA < valB) return sortOrderAsc ? -1 : 1;
          if (valA > valB) return sortOrderAsc ? 1 : -1;
          return 0;
        });
        
        filteredData = [headerRow].concat(sortedRows);
        renderSummaryTable(filteredData);
        document.getElementById("jobDetail").innerHTML = "<p>点击左侧项目查看详细信息</p>";
      }
      
      // 显示右侧详细信息，只显示“工作详情(HTML)”这一栏内容
      function showJobDetails(row) {
        const detailContainer = document.getElementById("jobDetail");
        detailContainer.innerHTML = "";
        if (detailColumnIndex !== -1) {
          const rawContent = (row[detailColumnIndex] !== undefined) ? row[detailColumnIndex] : "无工作详情";
          // 使用临时 DOM 以移除图片和特定 SVG
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = rawContent;
          const imgs = tempDiv.getElementsByTagName("img");
          while (imgs.length > 0) {
            imgs[0].parentNode.removeChild(imgs[0]);
          }
          const svgs = tempDiv.querySelectorAll("svg.jss131");
          svgs.forEach(svg => svg.parentNode.removeChild(svg));
          detailContainer.innerHTML = tempDiv.innerHTML;
        } else {
          detailContainer.innerHTML = "工作详情(HTML)列不存在。";
        }
      }
    });
  </script>
</body>
</html>