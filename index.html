<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel 数据显示</title>
  <style>
    /* 全局盒模型调整 */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      font-size: 2em;
    }
    /* 筛选框样式 */
    #filterDiv {
      text-align: center;
      margin: 10px 0;
    }
    #filterDiv select {
      padding: 5px;
      font-size: 16px;
    }
    /* 当数据过长时，允许水平滚动 */
    #excelData {
      overflow-x: auto;
      margin: 0 auto;
      max-width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th,
    td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
      word-wrap: break-word;
    }
    th {
      background-color: #f4f4f4;
    }
    tr:nth-child(even) {
      background-color: #fafafa;
    }
    /* 提示可排序的列增加指针效果 */
    th {
      cursor: default;
    }
    th.sortable {
      cursor: pointer;
    }
    .sort-indicator {
      font-size: 0.8em;
      margin-left: 5px;
    }
    /* 小屏幕自适应 */
    @media (max-width: 600px) {
      body {
        margin: 10px;
      }
      h1 {
        font-size: 1.5em;
      }
      th,
      td {
        padding: 8px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h1>Excel 数据显示</h1>
  <div id="filterDiv">
    <label for="jobTypeSelect">选择类型: </label>
    <select id="jobTypeSelect">
      <option value="">全部</option>
      <option value="Graduate Position">Graduate Position</option>
      <option value="Part-time Position">Part-time Position</option>
      <option value="Temporary Position">Temporary Position</option>
      <option value="Student Assistants via Work-on-Campus by CPS">Student Assistants via Work-on-Campus by CPS</option>
      <option value="Internship Position - Half- or One-year Internship">Internship Position - Half- or One-year Internship</option>
      <option value="Internship Position - Summer Internship">Internship Position - Summer Internship</option>
      <option value="Internship Position - Winter Internship">Internship Position - Winter Internship</option>
      <option value="Internship Position - Government Internship">Internship Position - Government Internship</option>
      <option value="Internship Position - STEM Internship">Internship Position - STEM Internship</option>
    </select>
  </div>
  <div id="excelData">加载中...</div>
  
  <!-- 引入 SheetJS XLSX 库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      let sortedColumn = null; // 当前排序的列（实际序号与 Excel 数据中列索引有关）
      let sortOrderAsc = true;  // true 为正序
      let tableData = [];       // 当前显示的表格数据（包含表头）
      let allTableData = [];    // 所有读取的 Excel 数据
      let typeColumnIndex = -1; // 表头中“类型”这一列的索引

      // 读取 Excel 数据
      fetch("job_listings.xlsx")
        .then(function(response) {
          return response.arrayBuffer();
        })
        .then(function(data) {
          var workbook = XLSX.read(data, { type: 'array' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];
          allTableData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          tableData = allTableData;

          // 查找“类型”这一列在原始 Excel 数据里的索引（注意：Excel 表头需要包含“类型”这一项）
          typeColumnIndex = allTableData[0].indexOf("类型");
          if (typeColumnIndex === -1) {
            console.warn("未找到‘类型’列，筛选功能将不可用。");
          }

          // 给下拉选择框绑定事件
          document.getElementById("jobTypeSelect").addEventListener("change", filterData);

          renderTable(tableData);
        })
        .catch(function(error) {
          console.error("读取 Excel 文件失败：", error);
          document.getElementById("excelData").innerHTML = "无法加载 Excel 数据。";
        });

      // 根据选择框过滤数据
      function filterData() {
        const selectedType = document.getElementById("jobTypeSelect").value;
        if (selectedType === "" || typeColumnIndex === -1) {
          // 选择“全部”或未找到类型列，则显示所有数据
          tableData = allTableData;
        } else {
          // 保留表头及类型列符合条件的数据行
          tableData = [ allTableData[0] ].concat(
            allTableData.slice(1).filter(function(row) {
              return row[typeColumnIndex] === selectedType;
            })
          );
        }
        // 重置排序状态
        sortedColumn = null;
        sortOrderAsc = true;
        renderTable(tableData);
      }

      // 渲染表格函数
      function renderTable(data) {
        var container = document.getElementById("excelData");
        container.innerHTML = "";
        var table = document.createElement("table");

        data.forEach(function(row, rowIndex) {
          var tr = document.createElement("tr");
          // 利用 row.slice(1) 忽略第一列（序号），从第二列开始显示
          row.slice(1).forEach(function(cell, cellIndex) {
            let cellElement;
            if (rowIndex === 0) {
              // 表头使用 th 标签
              cellElement = document.createElement("th");
              let headerText = cell;
              // 判断是否为可排序的列
              if (headerText === "招聘编号" || headerText === "发布时间" || headerText === "截止日期") {
                cellElement.classList.add("sortable");
                // 添加点击事件：cellIndex+1 为 Excel 中的实际列索引（因隐藏第一列）
                cellElement.addEventListener("click", function() {
                  sortTableByColumn(cellIndex + 1, headerText);
                });
                // 添加排序指示器
                var indicator = document.createElement("span");
                indicator.textContent = " ⇅";
                indicator.className = "sort-indicator";
                cellElement.appendChild(document.createTextNode(headerText));
                cellElement.appendChild(indicator);
              } else {
                cellElement.textContent = headerText;
              }
            } else {
              // 数据行使用 td 标签
              cellElement = document.createElement("td");
              cellElement.textContent = cell !== undefined ? cell : "";
            }
            tr.appendChild(cellElement);
          });
          table.appendChild(tr);
        });
        container.appendChild(table);
      }

      // 排序函数
      // 参数 columnIndex：对应 tableData 中的实际列索引（已考虑隐藏第一列）
      // 参数 columnName：用于判断是否为日期列等特殊处理
      function sortTableByColumn(columnIndex, columnName) {
        // 同一列连续点击则切换排序顺序，否则默认为正序
        if (sortedColumn === columnIndex) {
          sortOrderAsc = !sortOrderAsc;
        } else {
          sortedColumn = columnIndex;
          sortOrderAsc = true;
        }
        // 获取表头和数据（不排序表头）
        let header = tableData[0];
        let dataRows = tableData.slice(1);

        dataRows.sort(function(a, b) {
          let valA = a[columnIndex] || "";
          let valB = b[columnIndex] || "";

          // 如果是日期列，先将字符串转换为日期进行比较
          if (columnName === "发布时间" || columnName === "截止日期") {
            let dateA = Date.parse(valA);
            let dateB = Date.parse(valB);
            if (!isNaN(dateA) && !isNaN(dateB)) {
              return sortOrderAsc ? dateA - dateB : dateB - dateA;
            }
          }

          // 如果两者均为数字，则按数字比较
          let numA = parseFloat(valA);
          let numB = parseFloat(valB);
          if (!isNaN(numA) && !isNaN(numB)) {
            return sortOrderAsc ? numA - numB : numB - numA;
          }

          // 默认按字符串比较
          if (valA < valB) return sortOrderAsc ? -1 : 1;
          if (valA > valB) return sortOrderAsc ? 1 : -1;
          return 0;
        });

        // 重新组合数据（头部 + 排序后的数据行）并渲染表格
        tableData = [header].concat(dataRows);
        renderTable(tableData);
      }
    });
  </script>
</body>
</html>